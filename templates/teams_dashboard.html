{% extends "base.html" %}

{% block title %}IPL Team Statistics{% endblock %}

{% block content %}
<div class="ipl-dashboard teams-page">
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
      <a class="navbar-brand" href="{{ url_for('dashboard') }}">
        <img src="{{ url_for('static', filename='images/ipl-logo.png') }}" alt="IPL Logo" class="nav-logo">
        IPL Stats Dashboard
      </a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ml-auto">
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('dashboard') }}">Home</a>
          </li>
          <li class="nav-item active">
            <a class="nav-link" href="{{ url_for('teams_dashboard') }}">Team Stats</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('players_dashboard') }}">Player Stats</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('logout') }}">Logout</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <section class="team-stats">
    <div class="container">
      <h1 class="section-title">Team Statistics</h1>
      
      <div class="team-selection mb-5">
        <div class="card">
          <div class="card-body">
            <h3>Select a Team</h3>
            <div class="team-grid" id="teamGrid">
              <!-- Team logos will be loaded dynamically via JavaScript -->
              <div class="text-center py-3">
                <div class="spinner-border text-primary" role="status">
                  <span class="sr-only">Loading...</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="teamStatsContainer" class="team-stats-container d-none">
        <div class="row">
          <div class="col-md-4">
            <div class="card">
              <div class="card-header bg-primary text-white">
                <h4 class="mb-0">Team Overview</h4>
              </div>
              <div class="card-body">
                <div class="text-center mb-4">
                  <img id="teamLogo" src="" alt="Team Logo" class="team-logo-large">
                  <h3 id="teamName" class="mt-3"></h3>
                </div>
                <div class="team-overview">
                  <div class="stat-item">
                    <span class="stat-label">Total Matches</span>
                    <span id="totalMatches" class="stat-value">-</span>
                  </div>
                  <div class="stat-item">
                    <span class="stat-label">Wins</span>
                    <span id="totalWins" class="stat-value">-</span>
                  </div>
                  <div class="stat-item">
                    <span class="stat-label">Losses</span>
                    <span id="totalLosses" class="stat-value">-</span>
                  </div>
                  <div class="stat-item">
                    <span class="stat-label">Win Rate</span>
                    <span id="winRate" class="stat-value">-</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-8">
            <div class="card">
              <div class="card-header bg-primary text-white">
                <h4 class="mb-0">Performance Against Other Teams</h4>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-striped table-hover">
                    <thead>
                      <tr>
                        <th>Opponent</th>
                        <th>Matches</th>
                        <th>Wins</th>
                        <th>Losses</th>
                        <th>Win %</th>
                      </tr>
                    </thead>
                    <tbody id="teamRecordsBody">
                      <tr>
                        <td colspan="5" class="text-center">Select a team to view stats</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Fetch all teams that have played in IPL
  fetch('/api/teams-played-ipl')
    .then(response => response.json())
    .then(data => {
      if (data.error) {
        alert('Error: ' + data.error);
        return;
      }
      
      const teamGrid = document.getElementById('teamGrid');
      teamGrid.innerHTML = ''; // Clear loading spinner
      
      const teamLogos = {
        'Mumbai Indians': 'mi.png',
        'Chennai Super Kings': 'csk.png',
        'Royal Challengers Bangalore': 'rcb.png',
        'Kolkata Knight Riders': 'kkr.png',
        'Delhi Capitals': 'dc.png',
        'Sunrisers Hyderabad': 'srh.png',
        'Rajasthan Royals': 'rr.png',
        'Punjab Kings': 'pbks.png',
        'Gujarat Titans': 'gt.png',
        'Lucknow Super Giants': 'lsg.png',
        // Add more teams as needed
      };
      
      // Fixed: Accessing the teams from data.result.teams (API wraps response in 'result')
      data.result.teams.forEach(team => {
        const teamDiv = document.createElement('div');
        teamDiv.className = 'team-item';
        
        const logoFile = teamLogos[team] || 'default.png';
        
        teamDiv.innerHTML = `
          <div class="team-logo-container">
            <img src="/static/images/teams/${logoFile}" 
                 alt="${team}" class="team-logo" onerror="this.src='/static/images/ipl-logo.png'">
          </div>
          <div class="team-name">${team}</div>
        `;
        
        teamDiv.addEventListener('click', () => loadTeamStats(team));
        teamGrid.appendChild(teamDiv);
      });
    })
    .catch(error => {
      console.error('Error fetching teams:', error);
      document.getElementById('teamGrid').innerHTML = 
        '<div class="alert alert-danger">Failed to load teams. Please try again later.</div>';
    });
    
  // Function to load team statistics
  function loadTeamStats(team) {
    // Show loading state
    document.getElementById('teamStatsContainer').classList.remove('d-none');
    document.getElementById('teamName').textContent = team;
    document.getElementById('totalMatches').textContent = '...';
    document.getElementById('totalWins').textContent = '...';
    document.getElementById('totalLosses').textContent = '...';
    document.getElementById('winRate').textContent = '...';
    document.getElementById('teamRecordsBody').innerHTML = 
      '<tr><td colspan="5" class="text-center"><div class="spinner-border spinner-border-sm" role="status"></div> Loading...</td></tr>';
    
    // Set team logo
    const teamLogos = {
      'Mumbai Indians': 'mi.png',
      'Chennai Super Kings': 'csk.png',
      'Royal Challengers Bangalore': 'rcb.png',
      'Kolkata Knight Riders': 'kkr.png',
      // Add more as needed
    };
    
    const logoFile = teamLogos[team] || 'default.png';
    document.getElementById('teamLogo').src = `/static/images/teams/${logoFile}`;
    document.getElementById('teamLogo').onerror = function() {
      this.src = '/static/images/ipl-logo.png';
    };
    
    // Fetch team records against all teams
    fetch(`/api/record-against-each-team?team=${encodeURIComponent(team)}`)
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          alert('Error: ' + data.error);
          return;
        }
        
        // Update team overview
        let totalMatches = 0;
        let totalWins = 0;
        const records = data.result;
        
        const tableBody = document.getElementById('teamRecordsBody');
        tableBody.innerHTML = '';
        
        Object.keys(records).forEach(opponent => {
          const record = records[opponent];
          const matches = record.wins + record.losses;
          const winPercentage = matches > 0 ? ((record.wins / matches) * 100).toFixed(1) : '0.0';
          
          totalMatches += matches;
          totalWins += record.wins;
          
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${opponent}</td>
            <td>${matches}</td>
            <td>${record.wins}</td>
            <td>${record.losses}</td>
            <td>${winPercentage}%</td>
          `;
          tableBody.appendChild(row);
        });
        
        // Update overview stats
        const totalLosses = totalMatches - totalWins;
        const overallWinRate = totalMatches > 0 ? ((totalWins / totalMatches) * 100).toFixed(1) : '0.0';
        
        document.getElementById('totalMatches').textContent = totalMatches;
        document.getElementById('totalWins').textContent = totalWins;
        document.getElementById('totalLosses').textContent = totalLosses;
        document.getElementById('winRate').textContent = overallWinRate + '%';
      })
      .catch(error => {
        console.error('Error fetching team stats:', error);
        document.getElementById('teamRecordsBody').innerHTML = 
          '<tr><td colspan="5" class="alert alert-danger">Failed to load team statistics. Please try again later.</td></tr>';
      });
  }
});
</script>
{% endblock %}